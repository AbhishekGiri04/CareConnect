<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareConnect - Hand Gesture Control</title>
    <link rel="stylesheet" href="/css/gesture-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üëã CareConnect Gesture Control</h1>
            <p>Control smart devices with hand movements</p>
        </header>

        <div class="main-controls">
            <div class="gesture-status">
                <span id="status-text">Disabled</span>
                <button id="enable-btn" class="enable-btn">Enable</button>
            </div>
            
            <div class="help-section">
                <button class="help-btn">‚ùì Help</button>
                <div class="help-content">
                    <p>Show 1-4 fingers to toggle LEDs</p>
                    <div class="gesture-guide">
                        <div class="gesture-item">1Ô∏è‚É£ One finger = Toggle LED 1 (Living Room)</div>
                        <div class="gesture-item">2Ô∏è‚É£ Two fingers = Toggle LED 2 (Bedroom)</div>
                        <div class="gesture-item">3Ô∏è‚É£ Three fingers = Toggle LED 3 (Kitchen)</div>
                        <div class="gesture-item">4Ô∏è‚É£ Four fingers = Toggle LED 4 (Bathroom)</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="camera-section">
            <h3>Live Camera Feed</h3>
            <div class="camera-container">
                <video id="video" autoplay muted></video>
                <canvas id="canvas"></canvas>
                <div class="camera-overlay">
                    <div id="detection-info" style="background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: bold;">
                        üé• Webcam will show here
                    </div>
                </div>
            </div>
            <button id="start-camera" class="camera-btn">‚ñ∂Ô∏è Start Camera</button>
        </div>

        <div class="test-section">
            <h3>Quick Test (Simulate Detection):</h3>
            <div class="test-buttons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <button class="test-btn" data-fingers="1" style="background: linear-gradient(45deg, #ff6b6b, #ee5a52); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                    1Ô∏è‚É£ üëÜ Living Room
                </button>
                <button class="test-btn" data-fingers="2" style="background: linear-gradient(45deg, #4ecdc4, #44a08d); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                    2Ô∏è‚É£ ‚úåÔ∏è Bedroom
                </button>
                <button class="test-btn" data-fingers="3" style="background: linear-gradient(45deg, #45b7d1, #3498db); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                    3Ô∏è‚É£ ü§ü Kitchen
                </button>
                <button class="test-btn" data-fingers="4" style="background: linear-gradient(45deg, #f7b731, #f39c12); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                    4Ô∏è‚É£ üññ Bathroom
                </button>
            </div>
            
            <style>
                .test-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                }
                
                .test-btn:active {
                    transform: translateY(0);
                }
            </style>
        </div>

        <div class="settings-section">
            <h3>Advanced Settings</h3>
            <div class="setting-item">
                <label>üéØ Sensitivity</label>
                <select id="sensitivity">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            <div class="setting-item">
                <label>üìè Detection Range</label>
                <select id="range">
                    <option value="close">0.5-1 feet</option>
                    <option value="medium" selected>1-3 feet</option>
                    <option value="far">3-5 feet</option>
                </select>
            </div>
            <div class="setting-item">
                <label>‚ö° Response Time</label>
                <select id="response">
                    <option value="instant" selected>Instant</option>
                    <option value="delayed">0.5s delay</option>
                    <option value="slow">1s delay</option>
                </select>
            </div>
        </div>

        <div class="status-section">
            <h3>System Status</h3>
            <div class="status-indicators">
                <div class="status-item">
                    <span id="system-status" class="status-dot red">üî¥</span>
                    <span id="system-text">Inactive</span>
                </div>
                <div class="status-details">
                    <span id="firebase-status">CareConnect: Connected</span> | 
                    <span id="camera-status">Camera: Inactive</span>
                </div>
            </div>
        </div>

        <div class="device-grid">
            <div class="device-card" data-device="1">
                <h4>üõãÔ∏è Living Room LED</h4>
                <div class="device-status off">OFF</div>
            </div>
            <div class="device-card" data-device="2">
                <h4>üõèÔ∏è Bedroom LED</h4>
                <div class="device-status off">OFF</div>
            </div>
            <div class="device-card" data-device="3">
                <h4>üç≥ Kitchen LED</h4>
                <div class="device-status off">OFF</div>
            </div>
            <div class="device-card" data-device="4">
                <h4>üõÅ Bathroom LED</h4>
                <div class="device-status off">OFF</div>
            </div>
        </div>

        <!-- Enhanced API Health Check -->
        <div class="status-section" style="margin-top: 30px;">
            <h3>üîó API & System Status</h3>
            <div id="api-status" class="status-details">
                üîÑ Initializing CareConnect Gesture API...
            </div>
            
            <!-- Gesture Statistics -->
            <div class="stats-section" style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                <h4>üìä Gesture Statistics</h4>
                <div id="gesture-stats" class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                    <div class="stat-item">
                        <span class="stat-label">Total Gestures:</span>
                        <span id="total-gestures" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Success Rate:</span>
                        <span id="success-rate" class="stat-value">0%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Avg Confidence:</span>
                        <span id="avg-confidence" class="stat-value">0%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Last Gesture:</span>
                        <span id="last-gesture-time" class="stat-value">None</span>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="resetAllDevices()" class="action-btn" style="background: #ff6b6b; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                    üîÑ Reset All Devices
                </button>
                <button onclick="console.log(getGestureStats())" class="action-btn" style="background: #4ecdc4; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                    üìä Show Stats
                </button>
                <button onclick="window.location.reload()" class="action-btn" style="background: #45b7d1; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                    üîÑ Refresh Page
                </button>
            </div>
        </div>
    </div>

    <!-- Load MediaPipe Gesture Detector -->
    <script src="/gesture-mediapipe.js"></script>
    
    <script>
        // CareConnect Gesture Control System with MediaPipe Integration
        let gestureDetector;
        let systemEnabled = false;
        let cameraActive = false;
        
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Initializing CareConnect Gesture Control System...');
            
            // Initialize MediaPipe gesture detector
            gestureDetector = new MediaPipeGestureDetector();
            
            // Set up event handlers
            gestureDetector.setGestureCallback((gestureData) => {
                handleGestureDetected(gestureData);
            });
            
            gestureDetector.setStatusCallback((status, message) => {
                handleStatusChange(status, message);
            });
            
            // Initialize MediaPipe
            await gestureDetector.initialize();
            
            // Bind UI events
            bindUIEvents();
            
            // Start health monitoring
            startHealthMonitoring();
            
            console.log('‚úÖ CareConnect Gesture Control System ready');
        });
        
        function handleGestureDetected(gestureData) {
            const { fingerCount, confidence, device, action, timestamp } = gestureData;
            
            console.log(`üëã Gesture detected: ${fingerCount} fingers (${Math.round(confidence * 100)}%)`);
            
            // Update detection display
            const detectionInfo = document.getElementById('detection-info');
            if (detectionInfo) {
                detectionInfo.innerHTML = `
                    <div class="detection-success">
                        <div class="gesture-count">${fingerCount} finger(s) detected</div>
                        <div class="confidence">${Math.round(confidence * 100)}% confidence</div>
                        <div class="action">${device.name} ${action}</div>
                    </div>
                `;
            }
            
            // Update device UI
            updateDeviceUI(fingerCount, device.status);
            
            // Show success animation
            showGestureSuccess(fingerCount);
            
            // Voice feedback
            speak(`${device.name} ${action}`);
            
            // Update statistics
            updateGestureStats();
        }
        
        function handleStatusChange(status, message) {
            console.log(`üìä Status: ${status} - ${message}`);
            
            const detectionInfo = document.getElementById('detection-info');
            if (detectionInfo && status === 'no_hand') {
                detectionInfo.innerHTML = `
                    <div class="detection-waiting">
                        <div class="waiting-icon">üëÅÔ∏è</div>
                        <div class="waiting-text">Watching for hand gestures...</div>
                        <div class="instruction">Show 1-4 fingers to control LEDs</div>
                    </div>
                `;
            }
        }
        
        function bindUIEvents() {
            // Enable/Disable system
            const enableBtn = document.getElementById('enable-btn');
            if (enableBtn) {
                enableBtn.addEventListener('click', toggleSystem);
            }
            
            // Camera controls
            const startCameraBtn = document.getElementById('start-camera');
            if (startCameraBtn) {
                startCameraBtn.addEventListener('click', toggleCamera);
            }
            
            // Test buttons
            document.querySelectorAll('.test-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const fingers = parseInt(e.target.dataset.fingers);
                    simulateGesture(fingers);
                });
            });
            
            // Settings
            const sensitivitySelect = document.getElementById('sensitivity');
            if (sensitivitySelect) {
                sensitivitySelect.addEventListener('change', (e) => {
                    const sensitivityMap = { low: 0.3, medium: 0.7, high: 0.9 };
                    const sensitivity = sensitivityMap[e.target.value] || 0.7;
                    
                    gestureDetector.updateConfig({ minDetectionConfidence: sensitivity });
                    console.log(`üéØ Sensitivity updated: ${e.target.value} (${sensitivity})`);
                });
            }
        }
        
        async function toggleSystem() {
            systemEnabled = !systemEnabled;
            
            const enableBtn = document.getElementById('enable-btn');
            const statusText = document.getElementById('status-text');
            const systemStatus = document.getElementById('system-status');
            const systemText = document.getElementById('system-text');
            
            if (systemEnabled) {
                console.log('üü¢ Enabling gesture control system');
                
                // Update UI
                if (enableBtn) enableBtn.textContent = 'Disable';
                if (statusText) statusText.textContent = 'Enabled';
                if (systemStatus) {
                    systemStatus.textContent = 'üü¢';
                    systemStatus.className = 'status-dot green';
                }
                if (systemText) systemText.textContent = 'Active';
                
                // Auto-start camera
                if (!cameraActive) {
                    await startCamera();
                }
                
                // Start detection
                const video = document.getElementById('video');
                if (video && cameraActive) {
                    await gestureDetector.startDetection(video);
                }
                
            } else {
                console.log('üî¥ Disabling gesture control system');
                
                // Update UI
                if (enableBtn) enableBtn.textContent = 'Enable';
                if (statusText) statusText.textContent = 'Disabled';
                if (systemStatus) {
                    systemStatus.textContent = 'üî¥';
                    systemStatus.className = 'status-dot red';
                }
                if (systemText) systemText.textContent = 'Inactive';
                
                // Stop detection
                gestureDetector.stopDetection();
            }
        }
        
        async function toggleCamera() {
            if (cameraActive) {
                await stopCamera();
            } else {
                await startCamera();
            }
        }
        
        async function startCamera() {
            try {
                console.log('üìπ Starting camera...');
                
                const video = document.getElementById('video');
                if (!video) {
                    throw new Error('Video element not found');
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                video.srcObject = stream;
                await video.play();
                
                cameraActive = true;
                
                // Update camera button
                const startCameraBtn = document.getElementById('start-camera');
                if (startCameraBtn) {
                    startCameraBtn.textContent = '‚èπÔ∏è Stop Camera';
                }
                
                // Update camera status
                const cameraStatus = document.getElementById('camera-status');
                if (cameraStatus) {
                    cameraStatus.textContent = 'Camera: Active';
                }
                
                console.log('‚úÖ Camera started successfully');
                
                // Start detection if system is enabled
                if (systemEnabled) {
                    await gestureDetector.startDetection(video);
                }
                
            } catch (error) {
                console.error('‚ùå Camera start failed:', error);
                alert('Camera access denied. Please allow camera permissions and refresh the page.');
            }
        }
        
        function stopCamera() {
            console.log('üìπ Stopping camera...');
            
            const video = document.getElementById('video');
            if (video && video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }
            
            cameraActive = false;
            
            // Update camera button
            const startCameraBtn = document.getElementById('start-camera');
            if (startCameraBtn) {
                startCameraBtn.textContent = '‚ñ∂Ô∏è Start Camera';
            }
            
            // Update camera status
            const cameraStatus = document.getElementById('camera-status');
            if (cameraStatus) {
                cameraStatus.textContent = 'Camera: Inactive';
            }
            
            // Stop detection
            gestureDetector.stopDetection();
        }
        
        function simulateGesture(fingerCount) {
            console.log(`üß™ Simulating ${fingerCount} finger gesture`);
            
            if (!systemEnabled) {
                alert('Please enable gesture control first');
                return;
            }
            
            gestureDetector.simulateGesture(fingerCount);
        }
        
        function updateDeviceUI(deviceId, status) {
            const deviceCard = document.querySelector(`[data-device="${deviceId}"]`);
            if (!deviceCard) return;
            
            const statusElement = deviceCard.querySelector('.device-status');
            if (!statusElement) return;
            
            if (status) {
                statusElement.textContent = 'ON';
                statusElement.className = 'device-status on';
            } else {
                statusElement.textContent = 'OFF';
                statusElement.className = 'device-status off';
            }
        }
        
        function showGestureSuccess(fingerCount) {
            const deviceCard = document.querySelector(`[data-device="${fingerCount}"]`);
            if (deviceCard) {
                deviceCard.classList.add('gesture-success');
                setTimeout(() => {
                    deviceCard.classList.remove('gesture-success');
                }, 1000);
            }
        }
        
        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.2;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                speechSynthesis.speak(utterance);
            }
        }
        
        function updateGestureStats() {
            const stats = gestureDetector.getStats();
            
            // Update stats display
            const totalGestures = document.getElementById('total-gestures');
            const successRate = document.getElementById('success-rate');
            const avgConfidence = document.getElementById('avg-confidence');
            const lastGestureTime = document.getElementById('last-gesture-time');
            
            if (totalGestures) totalGestures.textContent = stats.successfulGestures;
            if (successRate) successRate.textContent = `${stats.successRate}%`;
            if (avgConfidence) avgConfidence.textContent = '95%'; // Mock value
            if (lastGestureTime) {
                lastGestureTime.textContent = stats.lastDetectionTime ? 
                    new Date(stats.lastDetectionTime).toLocaleTimeString() : 'None';
            }
        }
        
        function startHealthMonitoring() {
            // Update API status periodically
            setInterval(async () => {
                try {
                    const response = await fetch('http://localhost:3001/api/gesture/health');
                    const data = await response.json();
                    
                    const apiStatus = document.getElementById('api-status');
                    if (apiStatus && data.success) {
                        apiStatus.innerHTML = `
                            ‚úÖ CareConnect API: ${data.status}<br>
                            üìä Active Devices: ${data.activeDevices}/${data.totalDevices}<br>
                            üëã Total Gestures: ${data.gestureCount || 0}<br>
                            üïí Health Check: ${new Date().toLocaleTimeString()}
                        `;
                    }
                } catch (error) {
                    const apiStatus = document.getElementById('api-status');
                    if (apiStatus) {
                        apiStatus.innerHTML = `
                            ‚ùå CareConnect API: Offline<br>
                            üíæ Using local storage mode<br>
                            üïí Last Check: ${new Date().toLocaleTimeString()}
                        `;
                    }
                }
            }, 30000);
        }
        
        // Global functions
        window.resetAllDevices = async () => {
            try {
                const response = await fetch('http://localhost:3001/api/gesture/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    console.log('üîÑ All devices reset');
                    speak('All devices reset');
                    
                    // Update UI
                    for (let i = 1; i <= 4; i++) {
                        updateDeviceUI(i, false);
                    }
                }
            } catch (error) {
                console.error('‚ùå Reset failed:', error);
            }
        };
        
        window.getGestureStats = () => {
            return gestureDetector ? gestureDetector.getStats() : null;
        };
    </script>
    
    <style>
        .detection-success {
            display: flex;
            flex-direction: column;
            gap: 4px;
            text-align: center;
        }
        
        .detection-waiting {
            display: flex;
            flex-direction: column;
            gap: 4px;
            text-align: center;
        }
        
        .gesture-count {
            font-weight: bold;
            color: #00ff00;
            font-size: 1.1em;
        }
        
        .confidence {
            font-size: 0.9em;
            color: #ffff00;
        }
        
        .action {
            font-size: 0.9em;
            color: #ffffff;
            font-weight: 600;
        }
        
        .waiting-icon {
            font-size: 1.5em;
            animation: pulse 2s infinite;
        }
        
        .waiting-text {
            color: #ffffff;
            font-weight: 600;
        }
        
        .instruction {
            color: #cccccc;
            font-size: 0.8em;
        }
        
        .detection-error {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ff6b6b;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .gesture-success {
            animation: gestureSuccess 1s ease-in-out;
        }
        
        @keyframes gestureSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(0, 255, 0, 0.5); }
            100% { transform: scale(1); }
        }
    </style>
</body>
</html>